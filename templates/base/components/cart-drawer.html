<div id="cartDrawer" class="cart-drawer">
    <div class="cart-drawer-header">
        <h3>سلة المشتريات</h3>
        <button id="closeCart" class="close-btn">&times;</button>
    </div>

    <div id="cartItems" class="cart-items">
        <!-- Items dynamically loaded by commerce-engine.js -->
        <p class="empty-msg">السلة فارغة</p>
    </div>

    <div class="cart-drawer-footer">
        <div class="cart-total">
            <span>الإجمالي:</span>
            <span id="cartTotal">0</span>
            <span>[[commerce.currency_symbol]]</span>
        </div>
        <button class="btn btn-primary btn-full" id="checkoutBtn">إتمام الطلب</button>
    </div>
</div>

<div id="cartOverlay" class="cart-overlay"></div>

<style>
    .cart-drawer {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100%;
        background: var(--surface);
        box-shadow: var(--shadow-xl);
        z-index: 2000;
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .cart-drawer.open {
        right: 0;
    }

    .cart-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1999;
        display: none;
    }

    .cart-overlay.open {
        display: block;
    }

    .cart-drawer-header {
        padding: var(--spacing-md);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cart-items {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-md);
    }

    .cart-drawer-footer {
        padding: var(--spacing-md);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-total {
        display: flex;
        justify-content: space-between;
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: var(--spacing-md);
    }

    .btn-full {
        width: 100%;
    }

    .cart-item {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
    }

    .cart-item-img {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        object-fit: cover;
    }

    .cart-item-info {
        flex: 1;
    }

    .cart-item-price {
        color: var(--primary);
        font-weight: bold;
    }

    @media (max-width: 400px) {
        .cart-drawer {
            width: 100%;
            right: -100%;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const drawer = document.getElementById('cartDrawer');
        const overlay = document.getElementById('cartOverlay');
        const itemsDiv = document.getElementById('cartItems');
        const totalSpan = document.getElementById('cartTotal');

        const openCart = () => { drawer.classList.add('open'); overlay.classList.add('open'); };
        const closeCart = () => { drawer.classList.remove('open'); overlay.classList.remove('open'); };

        document.getElementById('closeCart').onclick = closeCart;
        overlay.onclick = closeCart;

        // Custom Event to open cart from anywhere
        window.addEventListener('open-cart', openCart);

        // Sync with AHCommerce
        const renderCart = (cart) => {
            if (cart.length === 0) {
                itemsDiv.innerHTML = '<p class="empty-msg">السلة فارغة</p>';
                totalSpan.innerText = '0';
                return;
            }

            itemsDiv.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <img src="${item.image}" class="cart-item-img">
                    <div class="cart-item-info">
                        <strong>${item.name}</strong>
                        <div class="cart-item-price">${item.price} [[commerce.currency_symbol]]</div>
                        <div class="cart-item-qty">
                            <button onclick="AHCommerce.updateQuantity('${item.id}', ${item.quantity - 1})">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="AHCommerce.updateQuantity('${item.id}', ${item.quantity + 1})">+</button>
                        </div>
                    </div>
                </div>
            `).join('');

            totalSpan.innerText = AHCommerce.getCartTotal();
        };

        AHCommerce.onUpdate(renderCart);
        renderCart(AHCommerce.cart);
    });
</script>